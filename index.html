<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã˜ã‚ƒã‚“ã‘ã‚“å¯¾æˆ¦</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; text-align: center; padding: 20px; background-color: #f4f7f6; color: #333; }
        .box { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 450px; margin: 20px auto; }
        .hidden { display: none; }
        h1 { color: #2c3e50; }
        input { padding: 12px; font-size: 1rem; border: 1px solid #ddd; border-radius: 8px; width: 80%; margin-bottom: 15px; outline: none; }
        button { font-size: 1rem; padding: 12px 20px; cursor: pointer; border: none; border-radius: 8px; background-color: #3498db; color: white; transition: 0.3s; margin: 5px; }
        button:hover { background-color: #2980b9; transform: translateY(-2px); }
        button:active { transform: translateY(0); }
        .choice-btn { font-size: 1.5rem; width: 100px; height: 100px; border-radius: 50%; background-color: #fff; border: 2px solid #3498db; color: #3498db; }
        .choice-btn:hover { background-color: #3498db; color: white; }
        #result-area { margin-top: 25px; padding: 15px; border-radius: 8px; background-color: #e8f4fd; font-weight: bold; min-height: 50px; }
        .reset-btn { background-color: #e74c3c; margin-top: 30px; font-size: 0.8rem; }
        .reset-btn:hover { background-color: #c0392b; }
    </style>
</head>
<body>

    <div id="login-screen" class="box">
        <h1>ã˜ã‚ƒã‚“ã‘ã‚“ãƒ«ãƒ¼ãƒ </h1>
        <p>ãƒ«ãƒ¼ãƒ åã¨åå‰ã‚’æ±ºã‚ã¦å…¥å®¤ã—ã¦ã­</p>
        <input type="text" id="room-id" placeholder="ãƒ«ãƒ¼ãƒ åï¼ˆä¾‹ï¼šã²ã¿ã¤åŸºåœ°ï¼‰"><br>
        <input type="text" id="user-name" placeholder="ã‚ãªãŸã®åå‰"><br>
        <button onclick="joinRoom()">å…¥å®¤ã™ã‚‹</button>
    </div>

    <div id="game-screen" class="box hidden">
        <h2 id="display-room"></h2>
        <p id="status-msg">è‡ªåˆ†ã®æ‰‹ã‚’é¸ã‚“ã§ãã ã•ã„</p>
        
        <div id="actions">
            <button class="choice-btn" onclick="sendChoice('ã‚°ãƒ¼')">âœŠ<br>ã‚°ãƒ¼</button>
            <button class="choice-btn" onclick="sendChoice('ãƒãƒ§ã‚­')">âœŒï¸<br>ãƒãƒ§ã‚­</button>
            <button class="choice-btn" onclick="sendChoice('ãƒ‘ãƒ¼')">ğŸ–ï¸<br>ãƒ‘ãƒ¼</button>
        </div>

        <div id="result-area">ç›¸æ‰‹ã®é¸æŠã‚’å¾…ã£ã¦ã„ã¾ã™...</div>

        <button class="reset-btn" onclick="resetRoom()">ã“ã®ãƒ«ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- Firebaseè¨­å®šï¼ˆã‚ãªãŸã®ã‚‚ã®ã«å·®ã—æ›¿ãˆã¦ãã ã•ã„ï¼‰ ---
        const firebaseConfig = {
            apiKey: "AIzaSyAT3kYEBtFoYvr5znp79O37nssmVQCUdtU",
            authDomain: "lastbloom-ad42b.firebaseapp.com",
            projectId: "lastbloom-ad42b",
            storageBucket: "lastbloom-ad42b.firebasestorage.app",
            messagingSenderId: "1014173233981",
            appId: "1:1014173233981:web:a01ff5923741d4197d4b54"
        };
        // --------------------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let myName = "";
        let currentRoom = "";
        let hasChosen = false;

        // ã€å…¥å®¤ã€‘
        window.joinRoom = () => {
            currentRoom = document.getElementById('room-id').value.trim();
            myName = document.getElementById('user-name').value.trim();
            
            if(!currentRoom || !myName) return alert("ãƒ«ãƒ¼ãƒ åã¨åå‰ã‚’å…¥åŠ›ã—ã¦ã­");

            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('display-room').innerText = "ãƒ«ãƒ¼ãƒ : " + currentRoom;

            listenRoom();
        };

        // ã€é¸æŠè‚¢ã‚’é€ä¿¡ã€‘
        window.sendChoice = async (choice) => {
            const roomRef = doc(db, "rooms", currentRoom);
            hasChosen = true;
            document.getElementById('status-msg').innerText = "ã‚ãªãŸã¯ã€Œ" + choice + "ã€ã‚’é¸æŠæ¸ˆã¿";
            
            // è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã‚€
            await setDoc(roomRef, { [myName]: choice }, { merge: true });
        };

        // ã€ãƒªã‚»ãƒƒãƒˆã€‘
        window.resetRoom = async () => {
            if(confirm("ãƒ«ãƒ¼ãƒ å†…ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¦ã€æ–°ã—ãå¯¾æˆ¦ã‚’å§‹ã‚ã¾ã™ã‹ï¼Ÿ")) {
                await deleteDoc(doc(db, "rooms", currentRoom));
                hasChosen = false;
                document.getElementById('status-msg').innerText = "ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚æ‰‹ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚";
                document.getElementById('result-area').innerText = "å¾…æ©Ÿä¸­...";
            }
        };

        // ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã€‘
        function listenRoom() {
            onSnapshot(doc(db, "rooms", currentRoom), (docSnap) => {
                if (!docSnap.exists()) {
                    document.getElementById('result-area').innerText = "ä»–ã®å‚åŠ è€…ã‚’å¾…ã£ã¦ã„ã¾ã™...";
                    return;
                }

                const data = docSnap.data();
                const players = Object.keys(data);

                // è‡ªåˆ†ãŒã¾ã é¸ã‚“ã§ã„ãªã„ãªã‚‰ã€çµæœã‚’è¦‹ã›ãªã„
                if (!hasChosen || !data[myName]) {
                    document.getElementById('result-area').innerText = "è‡ªåˆ†ã®æ‰‹ã‚’é¸ã¶ã¨çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™";
                    return;
                }

                if (players.length >= 2) {
                    // 2äººä»¥ä¸Šã®ãƒ‡ãƒ¼ã‚¿ãŒæƒã£ãŸï¼
                    showResult(data, players);
                } else {
                    document.getElementById('result-area').innerText = "ç›¸æ‰‹ãŒé¸ã¶ã®ã‚’å¾…ã£ã¦ã„ã¾ã™...";
                }
            });
        }

        // ã€çµæœè¡¨ç¤ºã¨å‹æ•—åˆ¤å®šã€‘
        function showResult(data, players) {
            let resHtml = "ã€å¯¾æˆ¦çµæœã€‘<br>";
            players.forEach(name => {
                resHtml += `${name}ã•ã‚“: ${data[name]}<br>`;
            });

            // 2äººã®å ´åˆã®ã¿å‹æ•—ã‚’è¡¨ç¤º
            if(players.length === 2) {
                const p1 = players[0];
                const p2 = players[1];
                const winner = judge(data[p1], data[p2], p1, p2);
                resHtml += `<hr><span style='font-size:1.5rem; color:#e67e22;'>${winner}</span>`;
            } else if (players.length > 2) {
                resHtml += "<hr>3äººä»¥ä¸Šã„ã‚‹ã®ã§å‹æ•—åˆ¤å®šã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™";
            }

            document.getElementById('result-area').innerHTML = resHtml;
        }

        // ã˜ã‚ƒã‚“ã‘ã‚“å‹æ•—ãƒ­ã‚¸ãƒƒã‚¯
        function judge(c1, c2, n1, n2) {
            if (c1 === c2) return "å¼•ãåˆ†ã‘ï¼";
            if ((c1 === "ã‚°ãƒ¼" && c2 === "ãƒãƒ§ã‚­") || 
                (c1 === "ãƒãƒ§ã‚­" && c2 === "ãƒ‘ãƒ¼") || 
                (c1 === "ãƒ‘ãƒ¼" && c2 === "ã‚°ãƒ¼")) {
                return n1 + " ã®å‹åˆ©ï¼";
            }
            return n2 + " ã®å‹åˆ©ï¼";
        }
    </script>
</body>
</html>
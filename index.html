<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>çˆ†é€Ÿã˜ã‚ƒã‚“ã‘ã‚“ãƒ«ãƒ¼ãƒ </title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; }
        .box { border: 1px solid #ccc; padding: 20px; margin: 10px; border-radius: 8px; }
        .hidden { display: none; }
        button { font-size: 1.2rem; padding: 10px 20px; cursor: pointer; }
    </style>
</head>
<body>

    <h1>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã˜ã‚ƒã‚“ã‘ã‚“</h1>

    <div id="login-screen" class="box">
        <input type="text" id="room-id" placeholder="ãƒ«ãƒ¼ãƒ åï¼ˆä¾‹ï¼šroom1ï¼‰"><br><br>
        <input type="text" id="user-name" placeholder="ã‚ãªãŸã®åå‰"><br><br>
        <button onclick="joinRoom()">å…¥å®¤ã™ã‚‹</button>
    </div>

    <div id="game-screen" class="box hidden">
        <h2 id="display-room"></h2>
        <p id="player-info"></p>
        <div id="actions">
            <button onclick="sendChoice('ã‚°ãƒ¼')">âœŠã‚°ãƒ¼</button>
            <button onclick="sendChoice('ãƒãƒ§ã‚­')">âœŒï¸ãƒãƒ§ã‚­</button>
            <button onclick="sendChoice('ãƒ‘ãƒ¼')">ğŸ–ï¸ãƒ‘ãƒ¼</button>
        </div>
        <div id="result-area" style="margin-top: 20px; font-weight: bold; font-size: 1.5rem;"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // â˜…ã“ã“ã«Firebaseã®è¨­å®šã‚’ã‚³ãƒ”ãƒšã—ã¦ãã ã•ã„
        const firebaseConfig = {
            apiKey: "AIzaSyAT3kYEBtFoYvr5znp79O37nssmVQCUdtU",
            authDomain: "lastbloom-ad42b.firebaseapp.com",
            projectId: "lastbloom-ad42b",
            storageBucket: "lastbloom-ad42b.firebasestorage.app",
            messagingSenderId: "1014173233981",
            appId: "1:1014173233981:web:a01ff5923741d4197d4b54"
         };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let myName = "";
        let currentRoom = "";

        // å…¥å®¤ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã®å‡¦ç†
        window.joinRoom = async () => {
            currentRoom = document.getElementById('room-id').value;
            myName = document.getElementById('user-name').value;
            if(!currentRoom || !myName) return alert("åå‰ã¨ãƒ«ãƒ¼ãƒ åã‚’å…¥ã‚Œã¦ã­");

            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('display-room').innerText = "ãƒ«ãƒ¼ãƒ : " + currentRoom;

            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¦‹å®ˆã‚‹é–‹å§‹
            listenRoom();
        };

        // é¸æŠè‚¢ã‚’é€ã‚‹
        window.sendChoice = async (choice) => {
            const roomRef = doc(db, "rooms", currentRoom);
            // èª°ãŒä½•ã‚’å‡ºã—ãŸã‹æ›¸ãè¾¼ã‚€ï¼ˆæœ¬å½“ã¯ã‚‚ã£ã¨è¤‡é›‘ã§ã™ãŒã€ã¾ãšã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ï¼‰
            await updateDoc(roomRef, {
                [myName]: choice
            }).catch(async () => {
                // åˆã‚ã¦ã®ãƒ«ãƒ¼ãƒ ãªã‚‰ä½œæˆ
                await setDoc(roomRef, { [myName]: choice });
            });
            document.getElementById('result-area').innerText = "ç›¸æ‰‹ã®é¸æŠã‚’å¾…ã£ã¦ã„ã¾ã™...";
        };

        // éƒ¨å±‹ã®çŠ¶æ…‹ã‚’ãšã£ã¨ç›£è¦–ã™ã‚‹
        function listenRoom() {
            onSnapshot(doc(db, "rooms", currentRoom), (doc) => {
                const data = doc.data();
                if (!data) return;

                const keys = Object.keys(data);
                if (keys.length === 2) {
                    // 2äººæƒã£ãŸã‚‰çµæœè¡¨ç¤ºï¼
                    let res = "çµæœï¼š<br>";
                    keys.forEach(name => {
                        res += `${name}ã•ã‚“ã¯ã€Œ${data[name]}ã€<br>`;
                    });
                    document.getElementById('result-area').innerHTML = res;
                }
            });
        }
    </script>
</body>
</html>